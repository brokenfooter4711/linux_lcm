---
# 1. Run the existing role with the iterated name
- name: "Provisioning {{ current_vm_name }}"
  include_role:
    name: libvirt_provision
  vars:
    vm_name: "{{ current_vm_name }}"

# 2. Get the IP for THIS specific VM
- name: "Wait for {{ current_vm_name }} to get an IP"
  shell: "virsh -c {{ libvirt_uri }} domifaddr {{ current_vm_name }} --source lease | grep -oE '([0-9]{1,3}\\.){3}[0-9]{1,3}'"
  register: vm_ip
  until: vm_ip.stdout != ""
  retries: 25
  delay: 10

# 3. Add to inventory with a unique alias
- name: "Add {{ current_vm_name }} to dynamic inventory"
  add_host:
    name: "{{ vm_ip.stdout }}"
    groups: web_vms
    ansible_user: ansible
    vm_hostname: "{{ current_vm_name }}"
    # The '>' tells YAML to treat the following block as a single string
    ansible_ssh_common_args: >
      -o ProxyCommand="ssh -W %h:%p -i ~/.ssh/id_ed25519_popos 
      {{ hostvars[groups['hypervisors'][0]].ansible_user }}@{{ hostvars[groups['hypervisors'][0]].ansible_host }}"